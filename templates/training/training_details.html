{% extends 'base.html' %}

{% block title %}{{ page_title }} - UPG Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-chalkboard-teacher"></i> {{ training.name }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'training:training_list' %}">Training Sessions</a></li>
                <li class="breadcrumb-item active">{{ training.name }}</li>
            </ol>
        </nav>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'training:edit_training' training.id %}" class="btn btn-outline-primary">
            <i class="fas fa-edit"></i> Edit Training
        </a>
        <a href="{% url 'training:manage_attendance' training.id %}" class="btn btn-primary">
            <i class="fas fa-users"></i> Manage Attendance
        </a>
        <a href="{% url 'training:training_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<!-- Training Header Card -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-gradient-primary text-white">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-chalkboard-teacher fs-2"></i>
                    </div>
                    <div>
                        <h5 class="mb-1">{{ training.name }}</h5>
                        <div class="d-flex align-items-center gap-3">
                            <span><i class="fas fa-bookmark me-1"></i>Module: {{ training.module_id }}</span>
                            {% if training.module_number %}
                            <span><i class="fas fa-sort-numeric-up me-1"></i>Number: {{ training.module_number }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="mb-2">
                    {% if training.status == 'planned' %}
                    <span class="badge bg-light text-dark fs-6"><i class="fas fa-clock me-1"></i>{{ training.get_status_display }}</span>
                    {% elif training.status == 'active' %}
                    <span class="badge bg-success fs-6"><i class="fas fa-play me-1"></i>{{ training.get_status_display }}</span>
                    {% elif training.status == 'completed' %}
                    <span class="badge bg-info fs-6"><i class="fas fa-check me-1"></i>{{ training.get_status_display }}</span>
                    {% elif training.status == 'cancelled' %}
                    <span class="badge bg-danger fs-6"><i class="fas fa-times me-1"></i>{{ training.get_status_display }}</span>
                    {% endif %}
                </div>
                {% if training.start_date %}
                <div class="text-light">
                    <i class="fas fa-calendar me-1"></i>{{ training.start_date|date:"M d, Y" }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <h6 class="text-muted mb-1">Location</h6>
                    <p class="mb-0"><i class="fas fa-map-marker-alt text-primary me-1"></i>{{ training.location|default:"Not specified" }}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h6 class="text-muted mb-1">Duration</h6>
                    <p class="mb-0"><i class="fas fa-clock text-success me-1"></i>{{ training.duration_hours|default:"Not set" }} hours</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h6 class="text-muted mb-1">Assigned Mentor</h6>
                    <p class="mb-0">
                        <i class="fas fa-user-tie text-warning me-1"></i>
                        {% if training.assigned_mentor %}
                        {{ training.assigned_mentor.get_full_name }}
                        {% else %}
                        Not assigned
                        {% endif %}
                    </p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h6 class="text-muted mb-1">Max Capacity</h6>
                    <p class="mb-0"><i class="fas fa-users text-info me-1"></i>{{ training.max_households }} households</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-primary shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-6 text-primary mb-2">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="text-primary mb-1">{{ total_enrolled }}</h3>
                <p class="text-muted mb-2">Total Enrolled</p>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ enrollment_rate }}%"></div>
                </div>
                <small class="text-muted">{{ enrollment_rate }}% of capacity</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-6 text-success mb-2">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="text-success mb-1">{{ present_count }}</h3>
                <p class="text-muted mb-2">Present Today</p>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ attendance_rate }}%"></div>
                </div>
                <small class="text-muted">{{ attendance_rate }}% attendance</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-6 text-warning mb-2">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h3 class="text-warning mb-1">{{ absent_count }}</h3>
                <p class="text-muted mb-2">Absent Today</p>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: {% if total_enrolled > 0 %}{% widthratio absent_count total_enrolled 100 %}{% else %}0{% endif %}%"></div>
                </div>
                <small class="text-muted">
                    {% if total_enrolled > 0 %}
                    {% widthratio absent_count total_enrolled 100 %}% absent
                    {% else %}
                    No data
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-6 text-info mb-2">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3 class="text-info mb-1">{{ attendance_rate }}%</h3>
                <p class="text-muted mb-2">Attendance Rate</p>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ attendance_rate }}%"></div>
                </div>
                <small class="text-muted">
                    {% if attendance_rate >= 80 %}Excellent
                    {% elif attendance_rate >= 60 %}Good
                    {% elif attendance_rate >= 40 %}Average
                    {% else %}Poor
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Training Information -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle text-primary me-2"></i>Training Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-medium text-muted" style="width: 40%;">Training Name:</td>
                                <td>{{ training.name }}</td>
                            </tr>
                            <tr>
                                <td class="fw-medium text-muted">Module ID:</td>
                                <td><span class="badge bg-secondary">{{ training.module_id }}</span></td>
                            </tr>
                            <tr>
                                <td class="fw-medium text-muted">Module Number:</td>
                                <td>{{ training.module_number|default:"Not specified" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-medium text-muted">BM Cycle:</td>
                                <td>
                                    {% if training.bm_cycle %}
                                    <span class="badge bg-info">{{ training.bm_cycle.bm_cycle_name }}</span>
                                    {% else %}
                                    <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-medium text-muted">Status:</td>
                                <td>
                                    {% if training.status == 'planned' %}
                                    <span class="badge bg-secondary">{{ training.get_status_display }}</span>
                                    {% elif training.status == 'active' %}
                                    <span class="badge bg-success">{{ training.get_status_display }}</span>
                                    {% elif training.status == 'completed' %}
                                    <span class="badge bg-primary">{{ training.get_status_display }}</span>
                                    {% elif training.status == 'cancelled' %}
                                    <span class="badge bg-danger">{{ training.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-medium text-muted" style="width: 40%;">Start Date:</td>
                                <td>{{ training.start_date|date:"M d, Y"|default:"Not set" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-medium text-muted">Duration:</td>
                                <td>
                                    {% if training.time_taken %}
                                    {{ training.time_taken }}
                                    {% elif training.duration_hours %}
                                    {{ training.duration_hours }} hours (planned)
                                    {% else %}
                                    Not specified
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-medium text-muted">Location:</td>
                                <td>{{ training.location|default:"Not specified" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-medium text-muted">Participants:</td>
                                <td>{{ training.participant_count|default:"Not recorded" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-medium text-muted">Created:</td>
                                <td>{{ training.created_at|date:"M d, Y H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% if training.notes %}
                <hr>
                <div>
                    <h6 class="text-muted">Notes:</h6>
                    <p class="mb-0">{{ training.notes|linebreaks }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Enrolled Households -->
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list-check text-success me-2"></i>Enrolled Households</h5>
                <div class="d-flex gap-2">
                    <span class="badge bg-light text-dark">{{ total_enrolled }} enrolled</span>
                    <a href="{% url 'training:manage_attendance' training.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-edit"></i> Manage
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if attendances %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Household</th>
                                <th>Village</th>
                                <th>Training Date</th>
                                <th>Attendance Status</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attendance in attendances %}
                            <tr class="{% if attendance.attendance %}table-success table-success-light{% endif %}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            {% if attendance.attendance %}
                                            <i class="fas fa-check-circle text-success"></i>
                                            {% else %}
                                            <i class="fas fa-times-circle text-warning"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <strong>{{ attendance.household.name }}</strong><br>
                                            <small class="text-muted">{{ attendance.household.phone_number }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ attendance.household.village.name }}</span>
                                </td>
                                <td>{{ attendance.training_date|date:"M d, Y" }}</td>
                                <td>
                                    {% if attendance.attendance %}
                                    <span class="badge bg-success"><i class="fas fa-check me-1"></i>Present</span>
                                    {% else %}
                                    <span class="badge bg-warning"><i class="fas fa-times me-1"></i>Absent</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if attendance.attendance_marked_at %}
                                    <small class="text-muted">
                                        {{ attendance.attendance_marked_at|date:"M d, Y H:i" }}<br>
                                        by {{ attendance.marked_by.get_full_name|default:attendance.marked_by.username }}
                                    </small>
                                    {% else %}
                                    <small class="text-muted">Not marked</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users text-muted mb-3" style="font-size: 3rem;"></i>
                    <h6 class="text-muted">No households enrolled</h6>
                    <p class="text-muted mb-3">This training session has no households enrolled yet.</p>
                    <a href="{% url 'training:manage_attendance' training.id %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Households
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6><i class="fas fa-bolt"></i> Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'training:manage_attendance' training.id %}" class="btn btn-primary">
                        <i class="fas fa-users"></i> Manage Attendance
                    </a>
                    <a href="{% url 'training:edit_training' training.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-edit"></i> Edit Training Details
                    </a>
                    {% if training.status == 'planned' %}
                    <a href="{% url 'training:start_training' training.id %}" class="btn btn-outline-success">
                        <i class="fas fa-play"></i> Start Training
                    </a>
                    {% elif training.status == 'active' %}
                    <a href="{% url 'training:complete_training' training.id %}" class="btn btn-outline-info">
                        <i class="fas fa-check"></i> Complete Training
                    </a>
                    {% endif %}
                    <hr class="my-2">
                    <a href="{% url 'training:delete_training' training.id %}" class="btn btn-outline-danger"
                       onclick="return confirm('Are you sure you want to delete this training?')">
                        <i class="fas fa-trash"></i> Delete Training
                    </a>
                </div>
            </div>
        </div>

        <!-- Training Progress -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6><i class="fas fa-chart-pie"></i> Training Progress</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small text-muted">Enrollment Progress</span>
                        <span class="small fw-medium">{{ total_enrolled }}/{{ training.max_households }}</span>
                    </div>
                    <div class="progress mb-1" style="height: 10px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: {{ enrollment_rate }}%"></div>
                    </div>
                    <small class="text-muted">{{ enrollment_rate }}% of capacity</small>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small text-muted">Attendance Rate</span>
                        <span class="small fw-medium">{{ attendance_rate }}%</span>
                    </div>
                    <div class="progress mb-1" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ attendance_rate }}%"></div>
                    </div>
                    <small class="text-muted">
                        {% if attendance_rate >= 80 %}Excellent performance
                        {% elif attendance_rate >= 60 %}Good attendance
                        {% elif attendance_rate >= 40 %}Needs improvement
                        {% else %}Poor attendance
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h6><i class="fas fa-history"></i> Recent Activity</h6>
            </div>
            <div class="card-body">
                {% if recent_activity %}
                <div class="timeline">
                    {% for activity in recent_activity %}
                    <div class="d-flex align-items-start mb-3">
                        <div class="me-2 mt-1">
                            {% if activity.attendance %}
                            <i class="fas fa-check-circle text-success"></i>
                            {% else %}
                            <i class="fas fa-times-circle text-warning"></i>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <div class="small">
                                <strong>{{ activity.household.name }}</strong> marked as
                                {% if activity.attendance %}
                                <span class="text-success">present</span>
                                {% else %}
                                <span class="text-warning">absent</span>
                                {% endif %}
                            </div>
                            <div class="text-muted small">
                                {{ activity.attendance_marked_at|timesince }} ago
                                {% if activity.marked_by %}
                                by {{ activity.marked_by.get_full_name }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-clock mb-2"></i>
                    <p class="small mb-0">No recent activity</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS for better styling -->
<style>
.table-success-light {
    background-color: rgba(25, 135, 84, 0.05) !important;
}

.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
}

.timeline {
    max-height: 300px;
    overflow-y: auto;
}

.badge {
    font-weight: 500;
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
}
</style>
{% endblock %}