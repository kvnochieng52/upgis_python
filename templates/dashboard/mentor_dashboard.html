{% extends 'base.html' %}

{% block title %}Mentor Dashboard - UPG Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-chalkboard-teacher"></i> Mentor Dashboard</h1>
    <span class="badge bg-success fs-6">Welcome, {{ user.get_full_name|default:user.username }}</span>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>{{ stats.assigned_trainings }}</h4>
                <small>Assigned Trainings</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>{{ stats.active_trainings }}</h4>
                <small>Active Trainings</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>{{ stats.total_households }}</h4>
                <small>Total Households</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4>{{ stats.visits_this_month }}</h4>
                <small>Visits This Month</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h4>{{ stats.nudges_this_month }}</h4>
                <small>Calls This Month</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-purple text-white" style="background-color: #6f42c1;">
            <div class="card-body text-center">
                <h4>{{ stats.total_grant_applications }}</h4>
                <small>Grant Applications</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Current Trainings -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-chalkboard"></i> Current Trainings</h5>
                <a href="{% url 'training:training_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if current_trainings %}
                <div class="list-group list-group-flush">
                    {% for training in current_trainings %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ training.name }}</h6>
                            <small class="text-muted">{{ training.bm_cycle.bm_cycle_name }}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success">{{ training.get_status_display }}</span>
                            <br><small>{{ training.enrolled_households_count }}/{{ training.max_households }} households</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-chalkboard fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No active trainings assigned</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Household Management -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-users"></i> Your Households</h5>
                <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#addHouseholdModal">
                    <i class="fas fa-plus"></i> Add Household
                </button>
            </div>
            <div class="card-body">
                {% if mentor_households %}
                <div class="list-group list-group-flush">
                    {% for household in mentor_households %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ household.name }}</h6>
                            <small class="text-muted">{{ household.village.name }}
                                {% if household.head_phone_number or household.phone_number %}
                                - <i class="fas fa-phone"></i> {{ household.head_phone_number|default:household.phone_number }}
                                {% endif %}
                            </small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewHousehold({{ household.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="logVisit({{ household.id }})">
                                <i class="fas fa-home"></i>
                            </button>
                            {% if household.head_phone_number or household.phone_number %}
                            <button class="btn btn-sm btn-outline-success" onclick="makeDirectCall('{{ household.head_phone_number|default:household.phone_number }}', '{{ household.name }}', {{ household.id }})">
                                <i class="fas fa-phone"></i> Call
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-outline-secondary" disabled title="No phone number">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-users fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No households assigned yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Activities -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Activities</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <h6>Recent Visits</h6>
                        {% if recent_visits %}
                        <ul class="list-unstyled">
                            {% for visit in recent_visits %}
                            <li class="mb-2">
                                <i class="fas fa-home text-success"></i>
                                <strong>{{ visit.household.name }}</strong> - {{ visit.topic }}
                                <br><small class="text-muted">{{ visit.visit_date|date:"M d, Y" }} ({{ visit.get_visit_type_display }})</small>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted">No recent visits</p>
                        {% endif %}
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-12">
                        <h6>Recent Phone Calls</h6>
                        {% if recent_nudges %}
                        <ul class="list-unstyled">
                            {% for nudge in recent_nudges %}
                            <li class="mb-2">
                                <i class="fas fa-phone text-info"></i>
                                <strong>{{ nudge.household.name }}</strong> - {{ nudge.get_nudge_type_display }}
                                <br><small class="text-muted">{{ nudge.call_date|date:"M d, Y H:i" }} ({{ nudge.duration_minutes }} min)</small>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted">No recent calls</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions & Grants -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#logVisitModal">
                            <i class="fas fa-home"></i><br>Log Visit
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#logCallModal">
                            <i class="fas fa-phone"></i><br>Log Call
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-outline-success w-100" onclick="createReport()">
                            <i class="fas fa-file-alt"></i><br>Create Report
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{% url 'upg_grants:available_grants' %}" class="btn btn-outline-warning w-100">
                            <i class="fas fa-hand-holding-usd"></i><br>Available Grants
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{% url 'savings_groups:savings_list' %}" class="btn btn-outline-purple w-100" style="color: #6f42c1; border-color: #6f42c1;">
                            <i class="fas fa-piggy-bank"></i><br>Savings Groups
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{% url 'business_groups:group_list' %}" class="btn btn-outline-danger w-100">
                            <i class="fas fa-briefcase"></i><br>Business Groups
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grant Statistics -->
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-chart-bar"></i> Grant Applications Overview</h6>
                <a href="{% url 'upg_grants:application_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4 mb-2">
                        <h5 class="mb-0">{{ grant_stats.applied }}</h5>
                        <small class="text-muted">Applied</small>
                    </div>
                    <div class="col-4 mb-2">
                        <h5 class="mb-0">{{ grant_stats.under_review }}</h5>
                        <small class="text-muted">Under Review</small>
                    </div>
                    <div class="col-4 mb-2">
                        <h5 class="mb-0">{{ grant_stats.approved }}</h5>
                        <small class="text-muted">Approved</small>
                    </div>
                    <div class="col-4 mb-2">
                        <h5 class="mb-0">{{ grant_stats.disbursed }}</h5>
                        <small class="text-muted">Disbursed</small>
                    </div>
                    <div class="col-4 mb-2">
                        <h5 class="mb-0">{{ grant_stats.rejected }}</h5>
                        <small class="text-muted">Rejected</small>
                    </div>
                    <div class="col-4 mb-2">
                        <h5 class="mb-0">{{ grant_stats.total_applications }}</h5>
                        <small class="text-muted">Total</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Activities -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-calendar-alt"></i> Upcoming Activities</h6>
            </div>
            <div class="card-body">
                {% if upcoming_trainings %}
                <ul class="list-unstyled">
                    {% for training in upcoming_trainings %}
                    <li class="mb-2">
                        <i class="fas fa-chalkboard text-warning"></i>
                        <strong>{{ training.name }}</strong>
                        <br><small class="text-muted">Starts: {{ training.start_date|date:"M d, Y" }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No upcoming activities</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Grant Applications -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-file-invoice-dollar"></i> Recent Grant Applications</h5>
                <a href="{% url 'upg_grants:application_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if recent_grants %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Household</th>
                                <th>Grant Type</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for grant in recent_grants %}
                            <tr>
                                <td>
                                    <strong>{{ grant.household.name }}</strong><br>
                                    <small class="text-muted">{{ grant.household.village.name }}</small>
                                </td>
                                <td>{{ grant.get_grant_type_display }}</td>
                                <td>KES {{ grant.requested_amount|floatformat:0 }}</td>
                                <td>
                                    {% if grant.status == 'submitted' %}
                                    <span class="badge bg-warning text-dark">{{ grant.get_status_display }}</span>
                                    {% elif grant.status == 'under_review' %}
                                    <span class="badge bg-primary">{{ grant.get_status_display }}</span>
                                    {% elif grant.status == 'approved' %}
                                    <span class="badge bg-success">{{ grant.get_status_display }}</span>
                                    {% elif grant.status == 'disbursed' %}
                                    <span class="badge bg-success">{{ grant.get_status_display }}</span>
                                    {% elif grant.status == 'rejected' %}
                                    <span class="badge bg-danger">{{ grant.get_status_display }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ grant.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ grant.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <a href="{% url 'upg_grants:application_detail' grant.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-inbox text-muted fa-2x mb-2"></i>
                    <p class="text-muted">No grant applications yet</p>
                    <a href="{% url 'upg_grants:available_grants' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Apply for Grant
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Household Modal -->
<div class="modal fade" id="addHouseholdModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Household to Training</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addHouseholdForm">
                    <div class="mb-3">
                        <label class="form-label">Select Training</label>
                        <select class="form-select" name="training" required>
                            <option value="">Choose training...</option>
                            {% for training in current_trainings %}
                            <option value="{{ training.id }}">{{ training.name }} ({{ training.available_slots }} slots available)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Household</label>
                        <select class="form-select" name="household" required>
                            <option value="">Choose household...</option>
                            <!-- Will be populated via AJAX -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addHouseholdToTraining()">Add Household</button>
            </div>
        </div>
    </div>
</div>

<!-- Log Visit Modal -->
<div class="modal fade" id="logVisitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Household Visit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="logVisitForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Household</label>
                        <select class="form-select" name="household" required>
                            <option value="">Select household...</option>
                            {% for household in mentor_households %}
                            <option value="{{ household.id }}">{{ household.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Visit Date</label>
                        <input type="date" class="form-control" name="visit_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Visit Type</label>
                        <select class="form-select" name="visit_type" required>
                            <option value="on_site">On-site Visit</option>
                            <option value="phone">Phone Check</option>
                            <option value="virtual">Virtual Meeting</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Topic/Purpose</label>
                        <input type="text" class="form-control" name="topic" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitVisit()">Log Visit</button>
            </div>
        </div>
    </div>
</div>

<!-- Log Call Modal -->
<div class="modal fade" id="logCallModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Phone Call</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="logCallForm" method="POST" action="{% url 'training:log_phone_nudge' %}" onsubmit="return validateAndSubmitCall(event)">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Household</label>
                        <select class="form-select" name="household" id="callHouseholdSelect" required>
                            <option value="">Select household...</option>
                            {% for household in mentor_households %}
                            <option value="{{ household.id }}"
                                    data-phone="{{ household.head_phone_number|default:household.phone_number }}"
                                    data-name="{{ household.name }}">
                                {{ household.name }}
                                {% if household.head_phone_number or household.phone_number %}
                                - {{ household.head_phone_number|default:household.phone_number }}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Call Action Button -->
                    <div class="mb-3 text-center">
                        <button type="button" class="btn btn-success btn-lg" id="startCallBtn" onclick="startCall()" disabled>
                            <i class="fas fa-phone"></i> Start Call
                        </button>
                        <button type="button" class="btn btn-danger btn-lg d-none" id="endCallBtn" onclick="endCall()">
                            <i class="fas fa-phone-slash"></i> End Call
                        </button>
                    </div>

                    <!-- Call Status & Timer -->
                    <div class="mb-3 text-center d-none" id="callStatus">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-phone-volume"></i> Call in progress...
                            <div class="mt-2">
                                <h4 id="callTimer" class="mb-0">00:00</h4>
                                <small>Duration (tracking automatically)</small>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-2 mb-0">
                            <i class="fas fa-info-circle"></i> <strong>Return to this page when call ends</strong>
                            <br><small>The system will automatically detect when you return and ask about the call status</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Call Date</label>
                            <input type="date" class="form-control" name="call_date" id="call_date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Call Time</label>
                            <input type="time" class="form-control" name="call_time" id="call_time" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Call Type</label>
                        <select class="form-select" name="nudge_type" required>
                            <option value="reminder">Training Reminder</option>
                            <option value="follow_up">Follow-up Call</option>
                            <option value="support">Support Call</option>
                            <option value="check_in">Regular Check-in</option>
                            <option value="business_advice">Business Advice</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration (minutes)</label>
                        <input type="number" class="form-control bg-light" name="duration_minutes" id="duration_minutes" readonly>
                        <input type="hidden" name="duration_seconds" id="duration_seconds" value="0">
                        <small class="text-muted"><strong>Automatic only:</strong> Use "Start Call" button to track duration</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="successful_contact" id="successful_contact_modal" checked>
                            <label class="form-check-label" for="successful_contact_modal">
                                Successfully reached household
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Call Log</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Call management variables
let callStartTime = null;
let callTimerInterval = null;
let callDurationSeconds = 0;
let callInProgress = false;
let visibilityCheckInterval = null;

// Enable/disable start call button based on household selection
document.getElementById('callHouseholdSelect').addEventListener('change', function() {
    const startBtn = document.getElementById('startCallBtn');
    if (this.value) {
        startBtn.disabled = false;
    } else {
        startBtn.disabled = true;
    }
});

// Detect when user returns to the page (call ended/cancelled)
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible' && callInProgress) {
        // User returned to the page - ask if call completed
        setTimeout(() => {
            handleCallReturn();
        }, 500); // Small delay to ensure page is fully visible
    }
});

// Additional detection using focus event
window.addEventListener('focus', function() {
    if (callInProgress && !document.hidden) {
        setTimeout(() => {
            handleCallReturn();
        }, 500);
    }
});

function handleCallReturn() {
    if (!callInProgress) return;

    const confirmed = confirm(
        `Did you complete the phone call?\n\n` +
        `Call Duration: ${formatCallDuration(callDurationSeconds)}\n\n` +
        `Click OK if the call was completed.\n` +
        `Click Cancel if the call was cancelled/not made.`
    );

    if (confirmed) {
        // Call was completed - keep the duration
        endCall(true);
    } else {
        // Call was cancelled - reset everything
        cancelCall();
    }
}

function formatCallDuration(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes} minute${minutes !== 1 ? 's' : ''} ${secs} second${secs !== 1 ? 's' : ''}`;
}

function startCall() {
    const householdSelect = document.getElementById('callHouseholdSelect');
    const selectedOption = householdSelect.options[householdSelect.selectedIndex];
    const phoneNumber = selectedOption.getAttribute('data-phone');
    const householdName = selectedOption.getAttribute('data-name');

    if (!phoneNumber) {
        alert('No phone number available for this household');
        return;
    }

    // Start the call using device's native dialer
    window.location.href = `tel:${phoneNumber}`;

    // Start timer
    callStartTime = new Date();
    callDurationSeconds = 0;
    callInProgress = true;

    // Set call date and time to now
    const now = new Date();
    document.getElementById('call_date').value = now.toISOString().split('T')[0];
    document.getElementById('call_time').value = now.toTimeString().substring(0, 5);

    // Show call status and timer
    document.getElementById('callStatus').classList.remove('d-none');
    document.getElementById('startCallBtn').classList.add('d-none');
    document.getElementById('endCallBtn').classList.remove('d-none');

    // Start the timer display
    callTimerInterval = setInterval(updateCallTimer, 1000);

    // Show notification
    showCallNotification(`Calling ${householdName}...`);
}

function updateCallTimer() {
    callDurationSeconds++;
    const minutes = Math.floor(callDurationSeconds / 60);
    const seconds = callDurationSeconds % 60;

    const timerDisplay = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    document.getElementById('callTimer').textContent = timerDisplay;
}

function endCall(autoEnded = false) {
    // Stop the timer
    if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
    }

    callInProgress = false;

    // Update duration fields
    const durationMinutes = Math.ceil(callDurationSeconds / 60);
    document.getElementById('duration_minutes').value = durationMinutes;
    document.getElementById('duration_seconds').value = callDurationSeconds;

    // Hide call status and show start button
    document.getElementById('callStatus').classList.add('d-none');
    document.getElementById('startCallBtn').classList.remove('d-none');
    document.getElementById('endCallBtn').classList.add('d-none');

    // Show notification
    const message = autoEnded
        ? `Call completed. Duration: ${durationMinutes} minute${durationMinutes !== 1 ? 's' : ''}`
        : `Call ended. Duration: ${durationMinutes} minute${durationMinutes !== 1 ? 's' : ''}`;
    showCallNotification(message);
}

function cancelCall() {
    // Stop the timer
    if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
    }

    callInProgress = false;
    callDurationSeconds = 0;

    // Reset duration fields
    document.getElementById('duration_minutes').value = '';
    document.getElementById('duration_seconds').value = '0';

    // Hide call status and show start button
    document.getElementById('callStatus').classList.add('d-none');
    document.getElementById('startCallBtn').classList.remove('d-none');
    document.getElementById('endCallBtn').classList.add('d-none');

    // Reset timer display
    document.getElementById('callTimer').textContent = '00:00';

    // Show notification
    showCallNotification('Call cancelled. Please try again if needed.');
}

function showCallNotification(message) {
    // Create a temporary notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
    notification.style.zIndex = '9999';
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function addHouseholdToTraining() {
    const form = document.getElementById('addHouseholdForm');
    const trainingSelect = form.querySelector('select[name="training"]');
    const householdSelect = form.querySelector('select[name="household"]');

    if (!trainingSelect.value || !householdSelect.value) {
        alert('Please select both training and household');
        return;
    }

    const trainingId = trainingSelect.value;
    const householdId = householdSelect.value;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Submit via AJAX
    fetch(`/training/${trainingId}/add-household/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `household_id=${householdId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addHouseholdModal')).hide();
            window.location.reload();
        } else {
            alert(data.error || 'Failed to add household to training');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding household. Please try again.');
    });
}

function submitVisit() {
    const form = document.getElementById('logVisitForm');
    const formData = new FormData(form);

    // Basic validation
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Submit the form
    fetch("{% url 'training:log_visit' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            return response.text().then(text => {
                throw new Error('Failed to log visit: ' + text);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error logging visit. Please try again.');
    });
}

function validateAndSubmitCall(event) {
    const form = document.getElementById('logCallForm');

    // Validate required fields
    const household = form.querySelector('[name="household"]').value;
    const nudgeType = form.querySelector('[name="nudge_type"]').value;
    const callDate = form.querySelector('[name="call_date"]').value;
    const callTime = form.querySelector('[name="call_time"]').value;

    if (!household || !nudgeType || !callDate || !callTime) {
        alert('Please fill in all required fields (Household, Call Type, Date, and Time)');
        event.preventDefault();
        return false;
    }

    // STRICT: Check if duration is set from the timer (no manual entry allowed)
    const durationMinutes = document.getElementById('duration_minutes').value;
    const durationSeconds = document.getElementById('duration_seconds').value;

    if ((!durationMinutes || durationMinutes === '') && (!durationSeconds || durationSeconds === '0')) {
        alert('⚠️ No call duration recorded!\n\nYou must use the "Start Call" button to make the call and track duration automatically.\n\nManual duration entry is not allowed.');
        event.preventDefault();
        return false;
    }

    console.log('Submitting call log with data:', {
        household: household,
        nudge_type: nudgeType,
        call_date: callDate,
        call_time: callTime,
        duration_minutes: durationMinutes,
        duration_seconds: durationSeconds
    });

    // Reset call state before submission
    resetCallState();

    // Allow form to submit normally
    return true;
}

function resetCallState() {
    // Clear any running timer
    if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
    }
    callInProgress = false;
    callDurationSeconds = 0;
    callStartTime = null;
}

// Reset call state when modal is closed
document.getElementById('logCallModal').addEventListener('hidden.bs.modal', function() {
    if (callInProgress) {
        const shouldCancel = confirm('Call timer is still running. Cancel the call?');
        if (shouldCancel) {
            cancelCall();
        }
    }
});

function viewHousehold(householdId) {
    window.location.href = `/households/${householdId}/`;
}

function logVisit(householdId) {
    document.querySelector('#logVisitModal select[name="household"]').value = householdId;
    new bootstrap.Modal(document.getElementById('logVisitModal')).show();
}

function logCall(householdId) {
    document.querySelector('#logCallModal select[name="household"]').value = householdId;

    // Trigger change event to enable the start call button
    document.getElementById('callHouseholdSelect').dispatchEvent(new Event('change'));

    new bootstrap.Modal(document.getElementById('logCallModal')).show();
}

function makeDirectCall(phoneNumber, householdName, householdId) {
    // Open the log call modal with household pre-selected
    document.querySelector('#logCallModal select[name="household"]').value = householdId;

    // Trigger change event to enable the start call button
    document.getElementById('callHouseholdSelect').dispatchEvent(new Event('change'));

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('logCallModal'));
    modal.show();

    // Auto-start the call after a short delay (to allow modal to fully open)
    setTimeout(() => {
        startCall();
    }, 500);
}

function createReport() {
    window.location.href = "{% url 'training:create_mentoring_report' %}";
}

// Set default date to today
document.querySelector('input[name="visit_date"]').valueAsDate = new Date();

// Set default date and time for call logging
const now = new Date();
const callDateInput = document.querySelector('#logCallForm input[name="call_date"]');
const callTimeInput = document.querySelector('#logCallForm input[name="call_time"]');
if (callDateInput) {
    callDateInput.valueAsDate = now;
}
if (callTimeInput) {
    callTimeInput.value = now.toTimeString().substring(0, 5);
}
</script>

{% endblock %}