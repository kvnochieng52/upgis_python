{% extends 'base.html' %}

{% block title %}Mentor Dashboard - UPG Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-chalkboard-teacher"></i> Mentor Dashboard</h1>
    <span class="badge bg-success fs-6">Welcome, {{ user.get_full_name|default:user.username }}</span>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>{{ stats.assigned_trainings }}</h4>
                <small>Assigned Trainings</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>{{ stats.active_trainings }}</h4>
                <small>Active Trainings</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>{{ stats.total_households }}</h4>
                <small>Total Households</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4>{{ stats.visits_this_month }}</h4>
                <small>Visits This Month</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h4>{{ stats.nudges_this_month }}</h4>
                <small>Calls This Month</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4>{{ stats.pending_reports }}</h4>
                <small>Pending Reports</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Current Trainings -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-chalkboard"></i> Current Trainings</h5>
                <a href="{% url 'training:training_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if current_trainings %}
                <div class="list-group list-group-flush">
                    {% for training in current_trainings %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ training.name }}</h6>
                            <small class="text-muted">{{ training.bm_cycle.bm_cycle_name }}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success">{{ training.get_status_display }}</span>
                            <br><small>{{ training.enrolled_households_count }}/{{ training.max_households }} households</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-chalkboard fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No active trainings assigned</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Household Management -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-users"></i> Your Households</h5>
                <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#addHouseholdModal">
                    <i class="fas fa-plus"></i> Add Household
                </button>
            </div>
            <div class="card-body">
                {% if mentor_households %}
                <div class="list-group list-group-flush">
                    {% for household in mentor_households %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ household.name }}</h6>
                            <small class="text-muted">{{ household.village.name }}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewHousehold({{ household.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="logVisit({{ household.id }})">
                                <i class="fas fa-home"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="logCall({{ household.id }})">
                                <i class="fas fa-phone"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-users fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No households assigned yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Activities -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Activities</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <h6>Recent Visits</h6>
                        {% if recent_visits %}
                        <ul class="list-unstyled">
                            {% for visit in recent_visits %}
                            <li class="mb-2">
                                <i class="fas fa-home text-success"></i>
                                <strong>{{ visit.household.name }}</strong> - {{ visit.topic }}
                                <br><small class="text-muted">{{ visit.visit_date|date:"M d, Y" }} ({{ visit.get_visit_type_display }})</small>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted">No recent visits</p>
                        {% endif %}
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-12">
                        <h6>Recent Phone Calls</h6>
                        {% if recent_nudges %}
                        <ul class="list-unstyled">
                            {% for nudge in recent_nudges %}
                            <li class="mb-2">
                                <i class="fas fa-phone text-info"></i>
                                <strong>{{ nudge.household.name }}</strong> - {{ nudge.get_nudge_type_display }}
                                <br><small class="text-muted">{{ nudge.call_date|date:"M d, Y H:i" }} ({{ nudge.duration_minutes }} min)</small>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted">No recent calls</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#logVisitModal">
                            <i class="fas fa-home"></i><br>Log Visit
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#logCallModal">
                            <i class="fas fa-phone"></i><br>Log Call
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-success w-100" onclick="createReport()">
                            <i class="fas fa-file-alt"></i><br>Create Report
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <a href="{% url 'training:training_list' %}" class="btn btn-outline-warning w-100">
                            <i class="fas fa-chalkboard"></i><br>View Trainings
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Activities -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-calendar-alt"></i> Upcoming Activities</h6>
            </div>
            <div class="card-body">
                {% if upcoming_trainings %}
                <ul class="list-unstyled">
                    {% for training in upcoming_trainings %}
                    <li class="mb-2">
                        <i class="fas fa-chalkboard text-warning"></i>
                        <strong>{{ training.name }}</strong>
                        <br><small class="text-muted">Starts: {{ training.start_date|date:"M d, Y" }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No upcoming activities</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Household Modal -->
<div class="modal fade" id="addHouseholdModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Household to Training</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addHouseholdForm">
                    <div class="mb-3">
                        <label class="form-label">Select Training</label>
                        <select class="form-select" name="training" required>
                            <option value="">Choose training...</option>
                            {% for training in current_trainings %}
                            <option value="{{ training.id }}">{{ training.name }} ({{ training.available_slots }} slots available)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Household</label>
                        <select class="form-select" name="household" required>
                            <option value="">Choose household...</option>
                            <!-- Will be populated via AJAX -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addHouseholdToTraining()">Add Household</button>
            </div>
        </div>
    </div>
</div>

<!-- Log Visit Modal -->
<div class="modal fade" id="logVisitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Household Visit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="logVisitForm">
                    <div class="mb-3">
                        <label class="form-label">Household</label>
                        <select class="form-select" name="household" required>
                            <option value="">Select household...</option>
                            {% for household in mentor_households %}
                            <option value="{{ household.id }}">{{ household.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Visit Date</label>
                        <input type="date" class="form-control" name="visit_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Visit Type</label>
                        <select class="form-select" name="visit_type" required>
                            <option value="on_site">On-site Visit</option>
                            <option value="phone">Phone Check</option>
                            <option value="virtual">Virtual Meeting</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Topic/Purpose</label>
                        <input type="text" class="form-control" name="topic" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitVisit()">Log Visit</button>
            </div>
        </div>
    </div>
</div>

<!-- Log Call Modal -->
<div class="modal fade" id="logCallModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Phone Call</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="logCallForm">
                    <div class="mb-3">
                        <label class="form-label">Household</label>
                        <select class="form-select" name="household" required>
                            <option value="">Select household...</option>
                            {% for household in mentor_households %}
                            <option value="{{ household.id }}">{{ household.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Call Date & Time</label>
                        <input type="datetime-local" class="form-control" name="call_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Call Type</label>
                        <select class="form-select" name="nudge_type" required>
                            <option value="reminder">Training Reminder</option>
                            <option value="follow_up">Follow-up Call</option>
                            <option value="support">Support Call</option>
                            <option value="check_in">Regular Check-in</option>
                            <option value="business_advice">Business Advice</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration (minutes)</label>
                        <input type="number" class="form-control" name="duration_minutes" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Successful Contact</label>
                        <select class="form-select" name="successful_contact" required>
                            <option value="true">Yes - Contact Made</option>
                            <option value="false">No - No Answer/Busy</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitCall()">Log Call</button>
            </div>
        </div>
    </div>
</div>

<script>
function addHouseholdToTraining() {
    alert('Add household functionality - to be implemented');
}

function submitVisit() {
    alert('Log visit functionality - to be implemented');
}

function submitCall() {
    alert('Log call functionality - to be implemented');
}

function viewHousehold(householdId) {
    alert(`View household ${householdId} - to be implemented`);
}

function logVisit(householdId) {
    document.querySelector('#logVisitModal select[name="household"]').value = householdId;
    new bootstrap.Modal(document.getElementById('logVisitModal')).show();
}

function logCall(householdId) {
    document.querySelector('#logCallModal select[name="household"]').value = householdId;
    new bootstrap.Modal(document.getElementById('logCallModal')).show();
}

function createReport() {
    alert('Create mentoring report - to be implemented');
}

// Set default date to today
document.querySelector('input[name="visit_date"]').valueAsDate = new Date();
document.querySelector('input[name="call_date"]').valueAsDate = new Date();
</script>

{% endblock %}